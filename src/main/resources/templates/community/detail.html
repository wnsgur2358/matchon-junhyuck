<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìƒì„¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/community/common.css}">
    <link rel="stylesheet" th:href="@{/css/community/board-detail.css}">
    <link rel="stylesheet" th:href="@{/css/community/modal.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/aibot/aichatbot.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="flex-layout">
<div class="page-wrapper">
    <div th:replace="~{common/header::header}"></div>

    <div class="content-box">
        <div class="post-header">
            <div class="post-header-actions">
                <a th:href="@{/community}" class="back-link">â† ëª©ë¡ìœ¼ë¡œ</a>
                <div class="post-action-right">

                    <div th:if="${#authentication.principal.member.memberRole.name() == 'ADMIN'}" class="admin-delete-wrapper">
                        <button type="button"
                                class="admin-delete-button"
                                th:attr="data-board-id=${board.id}">
                            ğŸ›‘ ê´€ë¦¬ì ì‚­ì œ
                        </button>
                    </div>
                    <div th:if="${board.member.id == #authentication.principal.member.id and #authentication.principal.member.memberRole.name() != 'ADMIN'}">
                        <button type="button"
                                class="board-delete-button"
                                th:attr="data-board-id=${board.id}">
                            âœ– ì‚­ì œ
                        </button>

                    </div>

                    <div th:if="${board.member.id != #authentication.principal.member.id}">
                        <button type="button" class="report-button"
                                th:onclick="'openReportModal(\'BOARD\', ' + ${board.id} + ')'">âš  ê²Œì‹œê¸€ ì‹ ê³ 
                        </button>
                    </div>
                </div>
            </div>

            <h2 th:text="${board.title}" class="post-title">ì œëª©</h2>

            <div class="post-meta meta-horizontal">
                <span><strong>ì‘ì„±ì:</strong> <span th:text="${board.member.memberName}"></span></span>
                <span><strong>ì¹´í…Œê³ ë¦¬:</strong> <span th:text="${board.category.displayName}"></span></span>
                <span><strong>ì‘ì„±ì¼:</strong> <span
                        th:text="${#temporals.format(board.createdDate, 'yyyy-MM-dd HH:mm')}"></span></span>
            </div>
        </div>

        <div class="post-body">
            <div th:utext="${board.content}" class="post-content"></div>

            <div th:if="${attachments != null and !attachments.isEmpty()}" class="attachment-box">
                <strong>ì²¨ë¶€íŒŒì¼</strong>
                <ul>
                    <li th:each="att : ${attachments}" class="attachment-item">

                        <img th:src="@{/img/attach-file.png}" alt="ì²¨ë¶€ ì•„ì´ì½˜" class="attachment-icon"/>

                        <a th:href="@{/community/download-force/{filename}(filename=${att.savedName})}"
                           th:text="${att.originalName}"></a>
                    </li>
                </ul>
            </div>
        </div>

        <div th:if="${board.member.id == #authentication.principal.member.id}" class="post-actions">
            <a th:href="@{'/community/' + ${board.id} + '/edit'}" class="edit-link">ìˆ˜ì •í•˜ê¸°</a>
        </div>
    </div>

    <div class="comment-section">
        <h3>ëŒ“ê¸€</h3>
        <form id="commentForm">
            <textarea id="commentContent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”." maxlength="500"></textarea>
            <button type="submit" class="comment-btn">ì‘ì„± ì™„ë£Œ</button>
        </form>

        <ul id="commentList">
            <li th:each="comment : ${comments}"
                th:attr="data-comment-id=${comment.id}, id='comment-' + ${comment.id}"
                th:classappend="${highlightedCommentId != null and highlightedCommentId == comment.id} ? 'highlight'">

                <div class="comment-meta">
                    <small>
                        <span th:text="${comment.member.memberName}">ì‘ì„±ì</span> |
                        <span th:text="${#temporals.format(comment.createdDate, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</span>
                    </small>
                    <div class="comment-actions">
                        <button type="button" class="admin-delete-button"
                                th:if="${#authentication.principal.member.memberRole.name() == 'ADMIN'}"
                                th:data-comment-id="${comment.id}"
                                th:data-board-id="${board.id}">
                            ğŸ›‘ ê´€ë¦¬ì ì‚­ì œ
                        </button>
                        <button type="button" class="btn-comment-delete"
                                th:data-comment-id="${comment.id}"
                                th:data-board-id="${board.id}"
                                th:if="${comment.member.id == #authentication.principal.member.id and #authentication.principal.member.memberRole.name() != 'ADMIN'}">
                            âœ– ì‚­ì œ
                        </button>

                        <button type="button" class="report-button"
                                th:if="${comment.member.id != #authentication.principal.member.id}"
                                th:onclick="'openReportModal(\'COMMENT\', ' + ${comment.id} + ')'">
                            âš  ëŒ“ê¸€ ì‹ ê³ 
                        </button>
                    </div>
                </div>
                <p th:text="${comment.content}"></p>
            </li>
        </ul>
    </div>
</div>

<div id="reportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3 class="report-modal-title">
            <img th:src="@{/img/free-icon-sirens-4377558.png}" alt="ì‹ ê³  ì•„ì´ì½˜" class="report-icon">
            ì‹ ê³ í•˜ê¸°
        </h3>

        <input type="hidden" id="reportTargetType">
        <input type="hidden" id="reportTargetId">

        <div class="form-group">
            <label for="reportReasonSelect">ì‹ ê³  ì‚¬ìœ </label>
            <select id="reportReasonSelect" required>
                <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                <option value="ABUSE">ìš•ì„¤/ë¹„ë°©/ê´´ë¡­í˜</option>
                <option value="ADVERTISEMENT">ìƒì—…/ê´‘ê³ ì„± ê¸€</option>
                <option value="SPAM">ë„ë°°ì„± ê¸€</option>
                <option value="IRRELEVANT">ì¹´í…Œê³ ë¦¬ ì·¨ì§€ì— ì–´ê¸‹ë‚¨</option>
                <option value="ETC">ê¸°íƒ€</option>
            </select>
        </div>

        <div class="form-group">
            <label for="reportReasonDetail">ìƒì„¸ ì‚¬ìœ </label>
            <textarea id="reportReasonDetail" rows="4" maxlength="500"
                      placeholder="ì‹ ê³  ìƒì„¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (300ì ì´ë‚´)" required></textarea>

        </div>

        <div class="modal-buttons">
            <button type="button" onclick="submitReport()">ì œì¶œ</button>
            <button type="button" onclick="closeReportModal()">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="user-info"
     th:attr="data-user-id=${#authentication.principal?.member?.id},
              data-user-role=${#authentication.principal?.member?.memberRole?.name()}">
</div>

<div th:replace="~{common/footer::footer}"></div>

<script>
    const userInfoEl = document.getElementById('user-info');
    const currentUserId = parseInt(userInfoEl.dataset.userId || '0');
    const currentUserRole = userInfoEl.dataset.userRole || 'GUEST';

    function formatDateTime(isoString) {
        const date = new Date(isoString);
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const hh = String(date.getHours()).padStart(2, '0');
        const mi = String(date.getMinutes()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    document.getElementById("commentForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const content = document.getElementById("commentContent").value.trim();
        const boardId = document.location.pathname.split("/")[2];
        const token = localStorage.getItem("accessToken");

        if (!content) {
            Swal.fire({text: 'ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', icon: 'warning', confirmButtonText: 'í™•ì¸'});
            return;
        }

        fetch(`/community/${boardId}/comments`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({content: content})
        })
            .then(res => res.json())
            .then(data => {
                const commentList = document.getElementById("commentList");
                const newComment = document.createElement("li");
                newComment.classList.add("highlighted");

                let actionButtons = "";
                if (data.memberId === currentUserId && currentUserRole !== 'ADMIN') {
                    actionButtons += `<button type="button" class="btn-comment-delete" data-comment-id="${data.commentId}" data-board-id="${boardId}">âœ– ì‚­ì œ</button>`;
                } else if (currentUserRole === 'ADMIN') {
                    actionButtons += `<button type="button" class="admin-delete-button" data-comment-id="${data.commentId}" data-board-id="${boardId}">ğŸ›‘ ê´€ë¦¬ì ì‚­ì œ</button>`;
                } else {
                    actionButtons += `<button type="button" class="report-button" onclick="openReportModal('COMMENT', ${data.commentId})">âš  ëŒ“ê¸€ ì‹ ê³ </button>`;
                }

                newComment.innerHTML = `
                <div class="comment-meta">
                    <small>${data.memberName} | ${formatDateTime(data.createdDate)}</small>
                    <div class="comment-actions">${actionButtons}</div>
                </div>
                <p>${data.content}</p>
            `;
                commentList.prepend(newComment);
                document.getElementById("commentContent").value = "";
            })
            .catch(err => {
                console.error("ëŒ“ê¸€ ë“±ë¡ ì˜¤ë¥˜:", err);
                Swal.fire({text: 'ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨', icon: 'warning', confirmButtonText: 'í™•ì¸'});
            });
    });

    document.addEventListener("click", function (e) {
        // ëŒ“ê¸€ ì‚­ì œ
        if (e.target.matches(".btn-comment-delete") || (e.target.matches(".admin-delete-button") && e.target.dataset.commentId)) {
            const commentId = e.target.dataset.commentId;
            const boardId = e.target.dataset.boardId;
            const token = localStorage.getItem("accessToken");

            Swal.fire({
                text: 'ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ì˜ˆ',
                cancelButtonText: 'ì•„ë‹ˆìš”'
            }).then((result) => {
                if (!result.isConfirmed) return;

                fetch(`/community/${boardId}/comments/${commentId}`, {
                    method: "DELETE",
                    headers: { 'Authorization': 'Bearer ' + token }
                }).then(res => {
                    if (res.status === 200) {
                        e.target.closest("li").remove();
                    } else {
                        res.text().then(msg => {
                            Swal.fire({text: msg || "ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨", icon: 'warning', confirmButtonText: 'í™•ì¸'});
                        });
                    }
                }).catch(err => {
                    console.error("ëŒ“ê¸€ ì‚­ì œ ì˜¤ë¥˜:", err);
                    Swal.fire({text: 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', icon: 'warning', confirmButtonText: 'í™•ì¸'});
                });
            });
        }

        // ê²Œì‹œê¸€ ì‚­ì œ
        if ((e.target.matches(".admin-delete-button") && !e.target.dataset.commentId)
            || e.target.matches(".board-delete-button")) {
            const boardId = e.target.dataset.boardId;

            Swal.fire({
                text: 'ì •ë§ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ì˜ˆ',
                cancelButtonText: 'ì•„ë‹ˆìš”'
            }).then((result) => {
                if (!result.isConfirmed) return;

                fetch(`/community/${boardId}/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                }).then(response => {
                    if (response.status === 401) {
                        Swal.fire({text: 'ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.', icon: 'warning', confirmButtonText: 'í™•ì¸'})
                            .then(() => window.location.href = "/login");
                    } else if (response.ok) {
                        Swal.fire({text: 'ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', icon: 'success', confirmButtonText: 'í™•ì¸'})
                            .then(() => window.location.href = "/community");
                    } else {
                        response.text().then(msg => {
                            Swal.fire({text: msg || "ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨", icon: 'warning', confirmButtonText: 'í™•ì¸'});
                        });
                    }
                }).catch(error => {
                    console.error("ê²Œì‹œê¸€ ì‚­ì œ ì˜¤ë¥˜:", error);
                    Swal.fire({text: 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', icon: 'warning', confirmButtonText: 'í™•ì¸'});
                });
            });
        }
    });

    function openReportModal(type, id) {
        document.getElementById("reportTargetType").value = type;
        document.getElementById("reportTargetId").value = id;
        document.getElementById("reportReasonSelect").value = "";
        document.getElementById("reportReasonDetail").value = "";
        document.getElementById("reportModal").style.display = "flex";
    }

    function closeReportModal() {
        document.getElementById("reportModal").style.display = "none";
    }

    function submitReport() {
        const type = document.getElementById("reportTargetType").value;
        const id = document.getElementById("reportTargetId").value;
        const selectedReasonType = document.getElementById("reportReasonSelect").value;
        const detailReason = document.getElementById("reportReasonDetail").value.trim();

        if (!selectedReasonType) {
            Swal.fire({text: 'ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', icon: 'warning', confirmButtonText: 'í™•ì¸'});
            return;
        }
        if (selectedReasonType === "ETC" && !detailReason) {
            Swal.fire({text: 'ê¸°íƒ€ ì‚¬ìœ ë¥¼ ì„ íƒí•œ ê²½ìš°, ìƒì„¸ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', icon: 'warning', confirmButtonText: 'í™•ì¸'});
            return;
        }

        const token = localStorage.getItem("accessToken");
        fetch("/community/reports", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "Authorization": "Bearer " + token
            },
            body: `type=${type}&targetId=${id}&reasonType=${selectedReasonType}&reason=${encodeURIComponent(detailReason)}`
        }).then(res => {
            if (res.status === 401) {
                //alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                Swal.fire({text: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', icon: 'warning', confirmButtonText: 'í™•ì¸'}).then(()=>{
                    location.href = "/login";
                });

            } else if (res.ok) {
                Swal.fire({text: 'ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.', icon: 'success', confirmButtonText: 'í™•ì¸'});
                closeReportModal();
            } else {
                res.text().then(msg => {
                    Swal.fire({text: msg, icon: 'warning', confirmButtonText: 'í™•ì¸'});
                });
            }
        }).catch(() => {
            Swal.fire({text: 'ì‹ ê³  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', icon: 'warning', confirmButtonText: 'í™•ì¸'});
        });
    }

    window.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const highlightId = params.get("highlight");
        if (highlightId) {
            const el = document.getElementById("comment-" + highlightId);
            if (el) {
                el.scrollIntoView({behavior: "smooth", block: "center"});
                el.classList.add("highlight");
            }
        }
    });
</script>
</body>
</html>